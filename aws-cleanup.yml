---
- name: AWS Webserver Infrastructure
  hosts: localhost
  vars:
    vpc_name: "webserver-vpc"
    project_name: "ansible"
    region: "eu-west-1"
    cidr: "10.0.0.0/16"
    cidr_public_a: "10.0.1.0/24"
    cidr_public_b: "10.0.4.0/24"
    zone1: "a"
    zone2: "b"

  tasks:
  - name: Get ec2 facts
    ec2_instance_info:
      region: "{{ region }}"
      filters:
        "tag:Ansible": webserver
    register: ec2

  - name: Get VPC info
    ec2_vpc_net_info:
      region: "{{ region }}"
      filters:
         "tag:Name": "{{ vpc_name }}"
    register: vpc

  - name: Terminate ec2 instances
    ec2:
      state: 'absent'
      region: "{{ region }}"
      instance_ids: '{{ item }}'
    loop:
      - "{{ ec2['instances'][0].instance_id }}"
      - "{{ ec2['instances'][1].instance_id }}"

  - name: Get ELB DNS info
    elb_application_lb_info:
      names: "webserverelb"
      region: "{{ region }}"
    register: elb

  - name: Debug
    debug:
      msg: "{{ elb[0].dns_name }}"

  - name: Remove ELB
    elb_application_lb:
      name: "webserverelb"
      region: "{{ region }}"
      state: absent
      wait: yes
      purge_listeners: yes

#  - name: Remove ELB Target Group
#    elb_target_group:
#      name: webservers
#      region: "{{ region }}"
#      protocol: http
#      port: 80
#      vpc_id: "{{ vpc.vpcs[0].id }}"
#      state: absent
#      wait_timeout: 200



#  - name: remove VPC
#    ec2_vpc_net:
#      name: "{{ vpc_name }}"
#     cidr_block: "{{ cidr }}"
#     region: "{{ region }}"
#      state: absent

